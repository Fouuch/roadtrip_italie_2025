<!DOCTYPE html>

<html>
<head>
<meta content="text/html; charset=utf-8" http-equiv="content-type"/>
<style>html, body {width: 100%;height: 100%;margin: 0;padding: 0;}</style>
<style>#map {position:absolute;top:0;bottom:0;right:0;left:0;}</style>
<link href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
<link href="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/leaflet.awesome.rotate.min.css" rel="stylesheet"/>
<meta content="width=device-width,
                initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<style>
                #map_a986607e6179f3d79f97a641d8d3543a {
                    position: relative;
                    width: 100.0%;
                    height: 100.0%;
                    left: 0.0%;
                    top: 0.0%;
                }
                .leaflet-container { font-size: 1rem; }

                  </style>
<style>
                    .leaflet-control-locate {
                        background: rgba(255, 255, 255, 0.6) !important;
                        border: 1px solid #ccc !important;
                        border-radius: 8px !important;
                        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2) !important;
                    }
                    </style>
<style>
#menu-actions {
  overflow: hidden;
  max-height: 0;
  transition: max-height 0.5s ease-out;
}
#menu-actions.open {
  max-height: 500px; /* assez grand pour tout le contenu */
  transition: max-height 0.5s ease-in;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link crossorigin="anonymous" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.awesome-markers/2.0.4/leaflet.awesome-markers.css" integrity="sha512-ZnM7kX+Tzt8kkfXk1laZ9J6EyRrZzdiA83PqGL2a1pVjIxtsRQdfMx0oVKY1Yg3IihZ1dVuCwRrY+a3x8kwFgA==" referrerpolicy="no-referrer" rel="stylesheet"/>
<script crossorigin="anonymous" integrity="sha512-PSqUGbyvQxQTVqB8XxR2f7NO6z1OcvL7EBZ+vD7wx79BuPy/xMbCwvfEyV+Mn8a1YjH4aaf5tt5mcO2gY2lfvg==" referrerpolicy="no-referrer" src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.awesome-markers/2.0.4/leaflet.awesome-markers.js"></script>
</head>
<body>
<style>
/* Rend la bo√Æte Leaflet transparente */
.leaflet-control-layers {
    background: none !important;
    border: none !important;
    box-shadow: none !important;
}

/* Bouton de l√©gende √©l√©gant */
#legend-toggle-button {
    background: rgba(255, 255, 255, 0.6);
    border: 1px solid #ccc;
    border-radius: 50px; /* Bouton compl√®tement arrondi */
    padding: 8px 16px;
    font-size: 14px;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    margin-bottom: 8px;
    text-align: center;
    transition: background 0.3s, box-shadow 0.3s;
}
#legend-toggle-button:hover {
    background: rgba(220, 220, 220, 0.8);
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
}

/* Lors de l'ouverture, la liste garde son fond blanc l√©ger */
.leaflet-control-layers-list {
    background: rgba(255, 255, 255, 0.8);
    padding: 10px;
    border-radius: 8px;
}
</style>
<style>
.leaflet-control-layers-overlays label span {
  font-size: 14px;
}
.leaflet-control-layers-overlays label span {
  display: inline-block;
  padding-left: 5px;
}
.leaflet-control-layers-overlays label span.bold {
  font-weight: bold;
  font-size: 16px;
}
</style>
<div class="folium-map" id="map_a986607e6179f3d79f97a641d8d3543a"></div>
<div id="manage-places" style="position:absolute; bottom:80px; left:10px; z-index:1000; display:flex; flex-direction:column; align-items:flex-start; gap:8px;">
<div id="toggle-menu-button" style="background: rgba(255,255,255,0.7); border: 1px solid #ccc; border-radius: 30px; padding: 10px 16px; font-size: 16px; cursor: pointer; box-shadow: 0 3px 10px rgba(0,0,0,0.3); text-align: center; transition: background 0.3s;">
    ‚öôÔ∏è Gestion des lieux
    </div>
<div id="menu-actions" style="background: rgba(255,255,255,0.95); border: 1px solid #ccc; border-radius: 12px; padding: 12px; display:none; box-shadow: 0 4px 12px rgba(0,0,0,0.3); flex-direction:column; gap:10px; width: 200px;">
<select id="marker-type" style="width:100%; padding:8px; border-radius:8px; font-size:14px;">
<option value="hebergement">üè® H√©bergement</option>
<option value="activite">üìç Activit√©</option>
<option value="lieubonux">‚≠ê Lieu bonus</option>
</select>
<button id="add-marker" style="padding:10px; border-radius:8px; background:#4CAF50; color:white; border:none; cursor:pointer; font-size:14px;">‚ûï Ajouter un lieu</button>
<button id="delete-marker" style="padding:10px; border-radius:8px; background:#f44336; color:white; border:none; cursor:pointer; font-size:14px;">üóëÔ∏è Supprimer ou Modifier</button>
</div>
</div>
<!-- Bouton pour changer le fond jour/nuit -->
<div id="mode-toggle" style="position:absolute; bottom:20px; right:10px; background: rgba(255,255,255,0.7); border: 1px solid #ccc; border-radius: 30px; padding: 10px 16px; font-size: 14px; cursor: pointer; box-shadow: 0 3px 10px rgba(0,0,0,0.3); text-align: center;">
üåì Mode Jour/Nuit
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
    var map = window.map_a986607e6179f3d79f97a641d8d3543a;
    var addingMode = false;
    var deletingMode = false;
    var customTileLayer = null;
    var addedMarkers = [];

    var toggleButton = document.getElementById('toggle-menu-button');
    var menuActions = document.getElementById('menu-actions');
    var modeToggle = document.getElementById('mode-toggle');

    toggleButton.addEventListener('click', function() {
        menuActions.classList.toggle('open');
    });

    document.getElementById('add-marker').addEventListener('click', function() {
        addingMode = true;
        deletingMode = false;
        map.getContainer().style.cursor = 'crosshair';
    });

    document.getElementById('delete-marker').addEventListener('click', function() {
        deletingMode = true;
        addingMode = false;
        map.getContainer().style.cursor = 'pointer';
    });

    function saveMarkers() {
        var saved = addedMarkers.map(function(marker) {
            return {
                lat: marker.getLatLng().lat,
                lng: marker.getLatLng().lng,
                popup: marker.getPopup().getContent(),
                type: marker.options.customType
            };
        });
        localStorage.setItem('addedMarkers', JSON.stringify(saved));
    }

    function loadMarkers() {
        var saved = localStorage.getItem('addedMarkers');
        if (saved) {
            JSON.parse(saved).forEach(function(data) {
                var iconDetails = {};
                if (data.type === "hebergement") {
                    iconDetails = {markerColor: "purple", icon: "home", prefix: "glyphicon"};
                } else if (data.type === "activite") {
                    iconDetails = {markerColor: "red", icon: "map-marker", prefix: "fa"};
                } else if (data.type === "lieubonux") {
                    iconDetails = {markerColor: "orange", icon: "star", prefix: "fa"};
                }
                var customIcon = L.AwesomeMarkers.icon(iconDetails);
                var marker = L.marker([data.lat, data.lng], {icon: customIcon, customType: data.type}).addTo(map)
                    .bindPopup(data.popup);
                addedMarkers.push(marker);
            });
        }
    }

    loadMarkers();

    map.on('click', function(e) {
        if (addingMode) {
            var latlng = e.latlng;
            Swal.fire({
                title: 'Nom du lieu üìç',
                input: 'text',
                inputPlaceholder: 'Exemple: Mus√©e de Florence',
                showCancelButton: true,
                confirmButtonText: 'Ajouter',
                cancelButtonText: 'Annuler'
            }).then((result) => {
                if (result.isConfirmed && result.value) {
                    var lieuNom = result.value;
                    var type = document.getElementById('marker-type').value;
                    var iconDetails = {};
                    if (type === "hebergement") {
                        iconDetails = {markerColor: "purple", icon: "home", prefix: "glyphicon"};
                    } else if (type === "activite") {
                        iconDetails = {markerColor: "red", icon: "map-marker", prefix: "fa"};
                    } else if (type === "lieubonux") {
                        iconDetails = {markerColor: "orange", icon: "star", prefix: "fa"};
                    }
                    var customIcon = L.AwesomeMarkers.icon(iconDetails);
                    var marker = L.marker([latlng.lat, latlng.lng], {icon: customIcon, customType: type}).addTo(map)
                        .bindPopup(lieuNom + " üìç");
                    addedMarkers.push(marker);
                    saveMarkers();
                }
                addingMode = false;
                map.getContainer().style.cursor = '';
            });
        }
    });

    map.on('popupopen', function(e) {
        if (deletingMode) {
            Swal.fire({
                title: 'Que voulez-vous faire ?',
                showDenyButton: true,
                showCancelButton: true,
                confirmButtonText: 'Modifier',
                denyButtonText: 'Supprimer',
                cancelButtonText: 'Annuler'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Modifier le lieu üìç',
                        input: 'text',
                        inputValue: e.popup.getContent().replace(" üìç", ""),
                        showCancelButton: true,
                        confirmButtonText: 'Mettre √† jour',
                        cancelButtonText: 'Annuler'
                    }).then((editResult) => {
                        if (editResult.isConfirmed && editResult.value) {
                            var type = document.getElementById('marker-type').value;
                            var iconDetails = {};
                            if (type === "hebergement") {
                                iconDetails = {markerColor: "purple", icon: "home", prefix: "glyphicon"};
                            } else if (type === "activite") {
                                iconDetails = {markerColor: "red", icon: "map-marker", prefix: "fa"};
                            } else if (type === "lieubonux") {
                                iconDetails = {markerColor: "orange", icon: "star", prefix: "fa"};
                            }
                            var customIcon = L.AwesomeMarkers.icon(iconDetails);
                            e.popup._source.setIcon(customIcon);
                            e.popup.setContent(editResult.value + " üìç");
                            e.popup._source.options.customType = type;
                            saveMarkers();
                        }
                    });
                } else if (result.isDenied) {
                    map.removeLayer(e.popup._source);
                    addedMarkers = addedMarkers.filter(function(marker) {
                        return marker !== e.popup._source;
                    });
                    saveMarkers();
                }
                deletingMode = false;
                map.getContainer().style.cursor = '';
            });
        }
    });

    // Mode Jour/Nuit
    var dayTile = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap contributors' });
    var nightTile = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '¬© CartoDB' });

    function fadeToNewTile(newTile) {
        if (customTileLayer) {
            map.removeLayer(customTileLayer);
        }
        map.addLayer(newTile);
        newTile.getContainer().style.opacity = 0;
        setTimeout(() => {
            newTile.getContainer().style.transition = 'opacity 1s';
            newTile.getContainer().style.opacity = 1;
        }, 10);
        customTileLayer = newTile;
    }

    function detectTimeAndSetTheme() {
        var now = new Date();
        var hour = now.getHours();
        if (hour >= 6 && hour < 18) {
            fadeToNewTile(dayTile);
        } else {
            fadeToNewTile(nightTile);
        }
    }

    detectTimeAndSetTheme();

    modeToggle.addEventListener('click', function() {
        if (customTileLayer === dayTile) {
            fadeToNewTile(nightTile);
        } else {
            fadeToNewTile(dayTile);
        }
    });
});
</script>
</body>
</html>